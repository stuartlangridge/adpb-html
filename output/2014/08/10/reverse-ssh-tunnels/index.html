<!DOCTYPE html>
<html lang="en">
<head>
		<title>as days pass by &mdash; Reverse SSH tunnels</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="http://www.kryogenix.org/days/theme/css/style.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
		<link rel="stylesheet" type="text/css" href="http://www.kryogenix.org/days/theme/css/simple-footnotes.css" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/rss+xml"
			title="as days pass by"
			href="http://www.kryogenix.org/days/feed" /> 
		<!--[if lte IE 8]><script src="http://www.kryogenix.org/days/theme/js/html5shiv.js"></script><![endif]-->
		<link rel="webmention" href="https://webmention.herokuapp.com/api/webmention" />
		<link rel="feed" href="http://www.kryogenix.org/days/archives/"> 
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<p>A blog by <a href="http://www.kryogenix.org/">Stuart Langridge</a></p>
				<h1 id="site-title"><a href="http://www.kryogenix.org/days">as days pass by</a></h1>
<h2 id="site-description">scratched tallies on the prison wall</h2>		</div><!-- /#banner -->
		
		<div id="menu">
			<div class="menu-navigation-container">
				<ul id="menu-navigation" class="menu">
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/">Kryogenix Consulting</a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/days/archives">All posts, ever</a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/code">Code</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general h-entry" id="post">
	<div class="entry-meta">
		<div class="date"><a href="http://www.kryogenix.org/days/2014/08/10/reverse-ssh-tunnels/"><time 
			class="dt-published" datetime="2014-08-10T23:49:00">Aug 10 2014</time></a>
			<span class="byline h-card">By <a class="p-author" href="http://www.kryogenix.org/days/"><img src="http://kryogenix.org/images/hackergotchi-simpler.png" class="u-photo" alt=""> <span class="p-name">sil</span></a></span>
		</div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a class="u-url p-name" href="http://www.kryogenix.org/days/2014/08/10/reverse-ssh-tunnels/" title="Permalink to Reverse SSH tunnels" rel="bookmark">Reverse <span class="caps">SSH</span>&nbsp;tunnels</a>
		</h2>
		<div class="entry-content e-content">
			<p>My dad’s got a computer. Infrequently, it goes wrong and I need to fix it. Slightly more frequently, it doesn’t go wrong but it does something which is confusing, and I need to try to fix it until I realise what the confusing thing was and then either fix <em>that</em> or explain it. So, being able to connect to his machine is useful.</p>
<p>His <span class="caps">ADSL</span> router, from TalkTalk<sup id="sf-reverse-ssh-tunnels-1-back"><a title="a Huawei HG533 with the most annoying web config UI I’ve ever seen ever, which gets even more annoying if you try and control it from curl because it’s all JavaScript-dependent. Why? You are a router, not gmail! Grrrr!" href="#sf-reverse-ssh-tunnels-1" class="simple-footnote">1</a></sup>, allows one to set up a port forward<sup id="sf-reverse-ssh-tunnels-2-back"><a title="hooray" href="#sf-reverse-ssh-tunnels-2" class="simple-footnote">2</a></sup> so that I can connect to his external <span class="caps">IP</span> and have that routed to port 22 on his machine, thus allowing me <span class="caps">SSH</span> access, and with <span class="caps">SSH</span> I can do everything else<sup id="sf-reverse-ssh-tunnels-3-back"><a title="hooray" href="#sf-reverse-ssh-tunnels-3" class="simple-footnote">3</a></sup>. However, that router also controls the <span class="caps">DHCP</span> addresses for things on the network, and it does not always give the same address out to the same machine. So, every now and again, it’ll give his machine a different <span class="caps">IP</span>, and then the port forward stops working.<sup id="sf-reverse-ssh-tunnels-4-back"><a title="Also, I really really don’t like static IPs, so I don’t want to configure it with one." href="#sf-reverse-ssh-tunnels-4" class="simple-footnote">4</a></sup></p>
<p>So, after mithering about this a bit, Daviey Walker suggested<sup id="sf-reverse-ssh-tunnels-5-back"><a title="that is, I was mithering about it. Not Daviey." href="#sf-reverse-ssh-tunnels-5" class="simple-footnote">5</a></sup> that I use a reverse <span class="caps">SSH</span> tunnel. That is to say: I have his machine ssh into one of mine, and then port forward a port on my machine back along the <span class="caps">SSH</span> tunnel to port 22 on his machine, meaning that I can ssh into it and don’t have to care about IPs or anything.</p>
<p>This was a dead clever idea. It relies on me having a machine which is sshable from the outside world, but I <em>do</em>, so that’s <span class="caps">OK</span>.</p>
<p>Obviously, something needs to set the tunnel up. So, first I set things up so that his machine could ssh into mine with key authentication and without a password needed (see <code>ssh-copy-id</code> or <a href="http://www.thegeekstuff.com/2008/11/3-steps-to-perform-ssh-login-without-password-using-ssh-keygen-ssh-copy-id/">a guide</a> for that), and then I wrote this little script:</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>
createTunnel<span class="o">()</span> <span class="o">{</span>
  date
  ssh -N -o <span class="nv">BatchMode</span><span class="o">=</span>yes -R 9102:localhost:22 mylogin@mysshablemachine
  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo </span>Tunnel created successfully
  <span class="k">else</span>
<span class="k">    </span><span class="nb">echo </span>An error occurred creating a tunnel. RC was <span class="nv">$?</span>
  <span class="k">fi</span>
<span class="o">}</span>
/bin/pidof ssh &gt; /dev/null
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nb">echo </span>Creating new tunnel connection
  createTunnel
<span class="k">fi</span>
</pre></div>


<p>which creates this ssh tunnel connection. There’s a hack there: it assumes that if there’s an ssh process, it’s our ssh process. If you regularly ssh from the box you’re doing this on, you’ll want to do something cleverer. In this case I don’t, so I keep it easy. Couple of little tricks in the script: there’s a <code>date</code> command, so the output mentions when this happened, which is useful for the log file in the next bit (and this is also why the script generates no output if the tunnel is already up). Secondly, <code>-o BatchMode=yes</code> in the ssh options means that it’ll instantly fail if you haven’t got key auth set up right, rather than hanging forever waiting for a password, and it’ll send server keepalives every 300 seconds and kill the connection if they break, which means that if the connection hangs but doesn’t terminate, it’ll get terminated. This is what we want, because we want some monitoring process to restart the tunnel if it dies. There are all sorts of clever ways to do this: upstart, systemd, whatever<sup id="sf-reverse-ssh-tunnels-6-back"><a title="not /etc/init.d though. This is a user-level process. It should not be being run by system-level stuff. System level belongs to apt." href="#sf-reverse-ssh-tunnels-6" class="simple-footnote">6</a></sup>, but I just put this line in the crontab<sup id="sf-reverse-ssh-tunnels-7-back"><a title="a file which defines jobs to be run at specific times; it’s like a super-techie Scheduled Tasks wizard, and it usefully will run things even when you’re not logged in. You can edit yours from the command line with crontab -e." href="#sf-reverse-ssh-tunnels-7" class="simple-footnote">7</a></sup>:</p>
<pre><code>*/1 * * * * /path/to/above/script.sh &gt;&gt; /path/to/tunnel.log 2&gt;&amp;1</code></pre>

<p>which just reruns the above script every minute and sticks any output into a logfile so if it’s not working I can, at a push, ask dad to read the logfile. Inefficient and low-budget, but it works. So once all this is set up, I can, from my sshable machine, do <code>ssh -p 9012 dadlogin@localhost</code> and I then get to log in to his machine. Then I can fix it. And never deal with his horrid router’s horrid web <span class="caps">UI</span> ever again.</p><ol class="simple-footnotes"><li id="sf-reverse-ssh-tunnels-1">a Huawei <span class="caps">HG533</span> with the most annoying web config <span class="caps">UI</span> I’ve ever seen ever, which gets even more annoying if you try and control it from curl because it’s all JavaScript-dependent. Why? You are a router, not gmail! Grrrr! <a href="#sf-reverse-ssh-tunnels-1-back" class="simple-footnote-back">↩</a></li><li id="sf-reverse-ssh-tunnels-2">hooray <a href="#sf-reverse-ssh-tunnels-2-back" class="simple-footnote-back">↩</a></li><li id="sf-reverse-ssh-tunnels-3">hooray <a href="#sf-reverse-ssh-tunnels-3-back" class="simple-footnote-back">↩</a></li><li id="sf-reverse-ssh-tunnels-4">Also, I really really don’t like static IPs, so I don’t want to configure it with one. <a href="#sf-reverse-ssh-tunnels-4-back" class="simple-footnote-back">↩</a></li><li id="sf-reverse-ssh-tunnels-5">that is, I was mithering about it. Not Daviey. <a href="#sf-reverse-ssh-tunnels-5-back" class="simple-footnote-back">↩</a></li><li id="sf-reverse-ssh-tunnels-6">not <code>/etc/init.d</code> though. This is a user-level process. It should not be being run by system-level stuff. System level belongs to apt. <a href="#sf-reverse-ssh-tunnels-6-back" class="simple-footnote-back">↩</a></li><li id="sf-reverse-ssh-tunnels-7">a file which defines jobs to be run at specific times; it’s like a super-techie Scheduled Tasks wizard, and it usefully will run things even when you’re not logged in. You can edit yours from the command line with <code>crontab -e</code>. <a href="#sf-reverse-ssh-tunnels-7-back" class="simple-footnote-back">↩</a></li></ol>
		</div> <!--/#entry-content-->
		<ul class="neighbours-links">
		<li><a href="http://www.kryogenix.org/days/2014/06/30/facebook-and-the-button-of-happiness/">Previous post</a></li>
		<li><a href="http://www.kryogenix.org/days/2014/08/18/do-you-do-it-anyway/">Next post</a></li>
		</ul>
	</div> <!--/#main-->
</div>  <!--/#post-->
<div id="webmentions">
<h4>More in the discussion (powered by <a href="http://indiewebcamp.com/Webmention">webmentions</a>)</h4>
	<ul><li>(no mentions, yet.)</li></ul>
<form id="wmform" method="POST" action="https://webmention.herokuapp.com/api/webmention">
	<label>Did you link to this post? Enter your page's URL:
	<input type="url" name="source"></label>
	<input type="hidden" name="target" value="http://www.kryogenix.org/days/2014/08/10/reverse-ssh-tunnels/">
	<input type="submit" value="Add link">
</form>
<script src="http://www.kryogenix.org/days/theme/live-webmentions.js"></script>
</div>

<p id="oldcomments"></p>
<script>
var aurl = '2014/08/10/reverse-ssh-tunnels/';
var parts = aurl.split('/');
if (parts[parts.length-1] === "") { parts = parts.slice(0, parts.length-1); }
var comurl = "/oldcomments/" + parts.join("-") + ".html";
var x = new XMLHttpRequest();
x.open("HEAD", comurl, true);
x.onreadystatechange = function() {
	if (x.readyState == 4) {
		if (x.status == 200) {
			document.getElementById("oldcomments").innerHTML = '<a href="' + comurl + '">See pre-2014 comments on this post</a>';
		}
	}
};
x.send();
</script>

		</div>
		
		<div id="footer">
			<p>Powered by <a href="http://pelican.readthedocs.org">Pelican</a>, theme by <a href="http://bunnyman.info">tBunnyMan</a>.</p>
				<script type="text/javascript">
					var _gaq = _gaq || [];
					_gaq.push(['_setAccount', 'UA-331575-1']);
					_gaq.push(['_trackPageview']);
					(function() {
						var ga = document.createElement('script'); 
						ga.type = 'text/javascript'; ga.async = true;
						ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
						var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
					})();

					// from https://paul.kinlan.me/detecting-injected-content/
					var detectInjection = function(knownHostsArray) {
						var requests = window.performance.getEntriesByType("resource");
						var unknownHosts = []; var knownHosts = {}; var foundHosts = {};
						for (var knownHost in knownHostsArray) {
							knownHosts[knownHostsArray[knownHost]] = true;
						}
						for (var requestIdx = 0; requestIdx < requests.length; requestIdx++) {
							var request = requests[requestIdx];
							var url = new URL(request.name);
							var host = url.host;
							// Aggregate all the requests from a host
							if(host in foundHosts) { foundHosts[host].push(request); } else { foundHosts[host] = new Array(request); }
						}
						for(var foundHost in foundHosts) {
							// If an unknown host is found, add it to a list.
							if(!(foundHost in knownHosts)) { unknownHosts.push(foundHost); }
						}
						return unknownHosts;
					};
					window.addEventListener("load", function() {
						var scripts = detectInjection(["kryogenix.org", "www.kryogenix.org", "www.google-analytics.com"]);
						if(!!scripts === true && scripts.length > 0) {
							for(var scriptsIdx = 0; scriptsIdx < scripts.length; scriptsIdx++) {
								var scr = scripts[scriptsIdx];
								ga('send', 'event', 'load', 'unknown-host', scr, {'nonInteraction': 1});
							}
						}
					});
				</script>
		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>