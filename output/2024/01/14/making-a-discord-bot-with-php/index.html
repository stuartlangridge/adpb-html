<!DOCTYPE html>
<html lang="en">
<head>
		<title>as days pass by &mdash; Making a Discord bot with PHP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<meta name="Description" content="Stuart Langridge of Kryogenix Consulting, for consultancy and custom development on the web and devices">
        <meta property="og:title" content="as days pass by &mdash; Making a Discord bot with PHP">
        <meta property="og:type" content="website">
        <meta property="og:site_name" content="as days pass by">
        <meta property="og:description" content="A post by Stuart Langridge (sil)">
        <meta property="og:image" content="https://www.kryogenix.org/days/2024/01/14/making-a-discord-bot-with-php/index.html.og_image.png">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@sil">
        <meta name="twitter:image" content="https://www.kryogenix.org/days/2024/01/14/making-a-discord-bot-with-php/index.html.og_image.png">
		<link rel="stylesheet" type="text/css" href="../../../../theme/css/adpb.css" />
		<link rel="stylesheet" type="text/css" href="../../../../theme/css/simple-footnotes.css" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="alternate" type="application/rss+xml"
			title="as days pass by"
			href="https://www.kryogenix.org/days/feed" /> 
		<meta property="fediverse:creator" content="@sil@mastodon.social" />
		<link rel="webmention" href="https://webmention.herokuapp.com/api/webmention" />
		<link rel="feed" href="https://www.kryogenix.org/days/archives/"> 
</head>

<body class="home blog custom-background single-author" >
		<header>
				<p>A blog by <a href="https://www.kryogenix.org/">Stuart Langridge</a></p>
				<h1 id="site-title"><a href="https://www.kryogenix.org/days">as days pass by</a></h1>
<h2 id="site-description">scratched tallies on the prison wall</h2>		</header><!-- /#banner -->
		
		<nav>
			<ul>
				<li><a href="/">Kryogenix Consulting</a></li>
				<li><a href="/days/archives">All posts, ever</a></li>
				<li><a href="/code">Code</a></li>
			</ul>
		</nav>
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general h-entry" id="post">
	<div class="entry-meta">
		<div class="date"><a href="https://www.kryogenix.org/days/2024/01/14/making-a-discord-bot-with-php/"><time 
			class="dt-published" datetime="2024-01-14T21:57:00+00:00">Jan 14 2024</time></a>
		</div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a class="u-url p-name" href="https://www.kryogenix.org/days/2024/01/14/making-a-discord-bot-with-php/">Making a Discord bot with PHP</a>
		</h2>
		<div class="entry-content e-content">
			<p>Discord have changed the way bots work quite a few times. Recently, though, they built a system that lets you create and register "slash commands" -- commands that you can type into the Discord chat and which do things, like <code>/hello</code> -- and which are powered by "webhooks". That is: when someone uses your command, it sends an HTTP request to a URL of your choice, and your URL then responds, and that process powers what your users see in Discord. Importantly, this means that operating a Discord bot does not require a long-running server process. You don't need to host it somewhere where you worry about the bot process crashing, how you're going to recover from that, all that stuff. No daemon required. In fact, you can make a complete Discord bot in one single PHP file. You don't even need any PHP libraries. One file, which you upload to your completely-standard shared hosting webspace, the same way you might upload any other simple PHP thing. Here's some notes on how I did that.</p>
<p>The <a href="https://discord.com/developers/docs/getting-started">Discord documentation</a> is pretty annoying and difficult to follow; all the stuff you need is in there, somewhere, but it's often hard to find where, and there's very little that explains <em>why</em> a thing is the way it is. It's tough to grasp the "Zen" of how Discord <em>wants</em> you to work with their stuff. But in essence, you'll need to create a Discord app: <a href="https://discord.com/developers/docs/getting-started#step-1-creating-an-app">follow their instructions</a> to do that. Then, we'll write our small PHP file, and upload it; finally, fill in the URL of that PHP file as the "interactive endpoint URL" in your newly-created app's general information page in the Discord developer admin. You can then add the bot to a server by visiting the URL from the "URL generator" for your app in the Discord dev admin.</p>
<p>The PHP file will get sent blocks of JSON, which describe what a user is doing -- a command they've typed, parameters to that command, or whatever -- and respond with something which is shown to the user -- the text of a message which is your bot's reply, or a command to alter the text of a previous message, or add a clickable button to it, and the like. I won't go into detail about all the things you can do here (if that would be interesting, let me know and maybe I'll write a followup or two), but the basic structure of your bot needs to be that it <strong>authenticates</strong> the incoming request from Discord, it <strong>interprets</strong> that request, and it <strong>responds</strong> to that request.</p>
<p>Authentication first. When you create your app, you get a <code>client_public_key</code> value, a big long string of hex digits that will look like <code>c78c32c3c7871369fa67</code> or whatever. Your PHP file needs to know this value somehow. (How you do that is up to you; think of this like a MySQL username and password, and handle this the same way you do those.) Then, every request that comes in will have two important HTTP headers: <code>X-Signature-ED25519</code> and <code>X-Signature-Timestamp</code>. You use a combination of these (which provide a signature for the incoming request) and your public key to check whether the request is legitimate. There are PHP libraries to do this, but fortunately we don't need them; PHP has the relevant <a href="https://www.php.net/manual/en/function.sodium-crypto-sign-verify-detached.php">signature verification</a> stuff built in, these days. So, to read the content of the incoming post and verify the signature on it:</p>
<div class="highlight"><pre><span></span><code><span class="x">/* read the incoming request data */</span>
<span class="x">$postData = file_get_contents(&#39;php://input&#39;);</span>
<span class="x">/* get the signature and timestamp header values */</span>
<span class="x">$signature = isset($_SERVER[&#39;HTTP_X_SIGNATURE_ED25519&#39;]) ? </span>
<span class="x">    $_SERVER[&#39;HTTP_X_SIGNATURE_ED25519&#39;] : &quot;&quot;;</span>
<span class="x">$timestamp = isset($_SERVER[&#39;HTTP_X_SIGNATURE_TIMESTAMP&#39;]) ? </span>
<span class="x">    $_SERVER[&#39;HTTP_X_SIGNATURE_TIMESTAMP&#39;] : &quot;&quot;;</span>
<span class="x">/* check the signature */</span>
<span class="x">$sigok = sodium_crypto_sign_verify_detached(</span>
<span class="x">    hex2bin($signature), </span>
<span class="x">    $timestamp . $postData,</span>
<span class="x">    hex2bin($client_public_key));</span>
<span class="x">/* If signature is not OK, reject the request */</span>
<span class="x">if (!$sigok) {</span>
<span class="x">    http_response_code(401);</span>
<span class="x">    die();</span>
<span class="x">}</span>
</code></pre></div>

<p>We need to correctly reject invalidly signed requests, because Discord will check that we do -- they will occasionally send test requests with bad signatures to confirm that you're doing the check. (They do this when you first add the URL to the Discord admin screens; if it won't let you save the settings, then it's because Discord thinks your URL returned the wrong thing. This is annoying, because you have no idea <em>why</em> Discord didn't like it; best bet is to add lots of <code>error_log()</code> logging of inputs and outputs to your PHP file and inspect the results carefully.)</p>
<p>Next, interpret the incoming request and do things with it. The only thing we have to respond to here is a <code>ping</code> message; Discord will send them as part of their irregular testing, and expects to get back a correctly-formatted <code>pong</code> message.</p>
<div class="highlight"><pre><span></span><code><span class="x">$data = json_decode($postData);</span>
<span class="x">if ($data-&gt;type == 1) { // this is a ping message</span>
<span class="x">    echo json_encode(array(&#39;type&#39; =&gt; 1)); // response: pong</span>
<span class="x">    die();</span>
<span class="x">}</span>
</code></pre></div>

<p>The magic numbers there (1 for a <code>ping</code>, 1 for a <code>pong</code>) are both defined in the Discord docs (incoming values being the <a href="https://discord.com/developers/docs/interactions/receiving-and-responding#interaction-object-interaction-type">"Interaction Type" field</a> and outgoing values the <a href="https://discord.com/developers/docs/interactions/receiving-and-responding#interaction-response-object-interaction-callback-type">"Interaction Callback Type"</a>.)</p>
<p>After that, the world's approximately your oyster. You check the incoming <code>type</code> field for the type of incoming thing this is -- a slash command, a button click in a message, whatever -- and respond appropriately. This is all stuff for future posts if there's interest, but the docs (in particular the <a href="https://discord.com/developers/docs/interactions/receiving-and-responding">"receiving and responding</a> and <a href="https://discord.com/developers/docs/interactions/message-components">"message components"</a> sections) have all the detail. For your bot to provide a slash command, you have to <a href="https://discord.com/developers/docs/interactions/application-commands#registering-a-command">register it first</a>, which is a faff; I wrote a little Python script to do that. You only have to do it once. The script looks approximately like this; you'll need your APP_ID and your BOT_TOKEN from the Discord dashboard.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">json</span>
<span class="n">MY_COMMAND</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s1">&#39;doit&#39;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s1">&#39;Do the thing&#39;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="n">discord_endpoint</span> <span class="o">=</span> <span class="n">_</span>
    <span class="sa">f</span><span class="s2">&quot;https://discord.com/api/v10/applications/</span><span class="si">{</span><span class="n">APP_ID</span><span class="si">}</span><span class="s2">/commands&quot;</span>
<span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">discord_endpoint</span><span class="p">,</span> 
    <span class="n">json</span><span class="o">=</span><span class="p">[</span><span class="n">MY_COMMAND</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bot </span><span class="si">{</span><span class="n">BOT_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s1">&#39;mybotname (myboturl, 1.0.0)&#39;</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div>

<p>Once you've done that, you can use <code>/doit</code> in a channel with your bot in, and your PHP bot URL will receive the incoming request for you to process.</p>
		</div> <!--/#entry-content-->
		<ul class="neighbours-links">
		<li><a href="https://www.kryogenix.org/days/2023/10/05/a-software-matter-device-that-alexa-can-talk-to/">Previous post</a></li>
		<li><a href="https://www.kryogenix.org/days/2024/01/30/somewhere-between-silver-and-tin/">Next post</a></li>
		</ul>

		<div class="hireme">
			I'm currently available for hire, to help you plan, architect, and build new systems, and for technical writing
			and articles. You can take a look at <a href="https://kryogenix.org">some projects I've worked on</a> and
			<a href="https://kryogenix.org/books">some of my writing</a>. If you'd like to talk about your upcoming project,
			do <a href="https://kryogenix.org/contact">get in touch.</a>
		</div>
	</div> <!--/#main-->
</div>  <!--/#post-->
<div id="webmentions">
<h4>More in the discussion (powered by <a href="http://indiewebcamp.com/Webmention">webmentions</a>)</h4>
	<ul><li>(no mentions, yet.)</li></ul>
<form id="wmform" method="POST" action="https://webmention.herokuapp.com/api/webmention">
	<label>Did you link to this post? Enter your page's URL:
	<input type="url" name="source"></label>
	<input type="hidden" name="target" value="https://www.kryogenix.org/days/2024/01/14/making-a-discord-bot-with-php/">
	<input type="submit" value="Add link">
</form>
<script src="https://www.kryogenix.org/days/theme/live-webmentions-cors.js"></script>
</div>

<p id="oldcomments"></p>
<script>
var aurl = '2024/01/14/making-a-discord-bot-with-php/';
var parts = aurl.split('/');
if (parts[parts.length-1] === "") { parts = parts.slice(0, parts.length-1); }
var tooNewForOldComments = false;
if (parts[0].match(/^[0-9]+$/)) {
	var asnum = parseInt(parts[0], 10);
	if (!isNaN(asnum) && asnum > 2014) {
		tooNewForOldComments = true;
	}
}
if (!tooNewForOldComments) {
	var comurl = "/oldcomments/" + parts.join("-") + ".html";
	var x = new XMLHttpRequest();
	x.open("HEAD", comurl, true);
	x.onreadystatechange = function() {
		if (x.readyState == 4) {
			if (x.status == 200) {
				document.getElementById("oldcomments").innerHTML = '<a href="' + comurl + '">See pre-2014 comments on this post</a>';
			}
		}
	};
	x.send();
}
</script>
<script type="module">
/* jslint esversion: 11 */
try {
	const resp = await fetch("/adpb-popular.json");
	const vals = await resp.json();
	let popular = vals[location.pathname];
	if (!popular && location.pathname.endsWith("/")) {
		popular = vals[location.pathname.replace(/\/$/, "")];
	}
	if (popular && popular.recent_idx != null) {
		let a = document.createElement("a");
		let p = document.createElement("p");
		p.className = "trending";
		a.href = "/adpb-popular.html";
		a.append(`#${popular.recent_idx + 1} in Trending`);
		p.append(a);
		const ec = document.querySelector("div.entry-content");
		ec.insertBefore(p, ec.firstChild);
	}
} catch(e) {
	console.error("Failed to fetch popular list", e);
}
</script>
<!-- <script src="https://www.kryogenix.org/days/theme/unrot-redirect.js"></script> -->
		</div>
		
		<footer>
			<p>Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
		</footer>




<div id="loadtimer"></div>
<script>
window.onload = function(){
    setTimeout(function(){
      window.performance = window.performance || 
window.mozPerformance || window.msPerformance || 
window.webkitPerformance || {};
      var t = performance.timing || {};
      if (!t) {
        
        return;
      }
      var start = t.navigationStart,
          end = t.loadEventEnd
          loadTime = (end - start) / 1000;
      var copy = document.getElementById('loadtimer');
      copy.innerHTML += "This page loaded in " + loadTime + " seconds.";
    }, 0); 
}

</script>
</body> </html>