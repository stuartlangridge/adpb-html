<!DOCTYPE html>
<html lang="en">
<head>
		<title>as days pass by &mdash; Not moving to Sofa (or moving from the sofa)</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<meta name="Description" content="Stuart Langridge of Kryogenix Consulting, for consultancy and custom development on the web and devices">
        <meta property="og:title" content="as days pass by &mdash; Not moving to Sofa (or moving from the sofa)">
        <meta property="og:type" content="website">
        <meta property="og:site_name" content="as days pass by">
        <meta property="og:description" content="A post by Stuart Langridge (sil)">
        <meta property="og:image" content="https://www.kryogenix.org/days/2009/09/13/not-moving-to-sofa-or-moving-from-the-sofa/index.html.og_image.png">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@sil">
        <meta name="twitter:image" content="https://www.kryogenix.org/days/2009/09/13/not-moving-to-sofa-or-moving-from-the-sofa/index.html.og_image.png">
		<link rel="stylesheet" type="text/css" href="../../../../theme/css/adpb.css" />
		<link rel="stylesheet" type="text/css" href="../../../../theme/css/simple-footnotes.css" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="alternate" type="application/rss+xml"
			title="as days pass by"
			href="https://www.kryogenix.org/days/feed" /> 
		<meta property="fediverse:creator" content="@sil@mastodon.social" />
		<link rel="webmention" href="https://webmention.herokuapp.com/api/webmention" />
		<link rel="feed" href="https://www.kryogenix.org/days/archives/"> 
</head>

<body class="home blog custom-background single-author" >
		<header>
				<p>A blog by <a href="https://www.kryogenix.org/">Stuart Langridge</a></p>
				<h1 id="site-title"><a href="https://www.kryogenix.org/days">as days pass by</a></h1>
<h2 id="site-description">scratched tallies on the prison wall</h2>		</header><!-- /#banner -->
		
		<nav>
			<ul>
				<li><a href="/">Kryogenix Consulting</a></li>
				<li><a href="/days/archives">All posts, ever</a></li>
				<li><a href="/code">Code</a></li>
			</ul>
		</nav>
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general h-entry" id="post">
	<div class="entry-meta">
		<div class="date"><a href="https://www.kryogenix.org/days/2009/09/13/not-moving-to-sofa-or-moving-from-the-sofa/"><time 
			class="dt-published" datetime="2009-09-13T10:22:00+01:00">Sep 13 2009</time></a>
		</div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a class="u-url p-name" href="https://www.kryogenix.org/days/2009/09/13/not-moving-to-sofa-or-moving-from-the-sofa/">Not moving to Sofa (or moving from the sofa)</a>
		</h2>
		<div class="entry-content e-content">
			<p>This weekend I've been playing with <a href="http://github.com/jchris/sofa">Sofa</a>, <a href="http://jchrisa.net">jchris</a>'s CouchDB blog
software. I like CouchDB, and I'm increasingly starting to thing that
although Wordpress is pretty good, it's the wrong path; it's serious
evolution running on a dead-end evolutionary path. Like an
electric-powered go-faster-striped penny farthing. So a move away is
something worth investigating. Sofa is pretty feature-poor by comparison
with Wordpress, but I actually don't care about almost all of the
Wordpress features anyway. Sofa's not too hard to set up, but then I
work with CouchDB all the time anyway. It'd likely be harder for others.
Importing posts from Wordpress took the longest to do, because I had to
write a script to do it, and overcome a Wordpress problem. When
exporting posts from Wordpress (under Tools &gt; Export) the downloaded
export XML file ended up being truncated because the export script took
too long to run (I've been posting here for seven years; it's built up.)
So I added <code>php_value max_execution_time 600</code> to my Wordpress
<code>.htaccess</code> file and that made it work. After that, and after installing
Sofa to CouchDB with CouchApp (as per Sofa instructions), a script:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">ET</span>
<span class="kn">import</span> <span class="nn">couchdb.client</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="s2">&quot;http://localhost:5984&quot;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">add_credentials</span><span class="p">(</span><span class="s2">&quot;sil&quot;</span><span class="p">,</span><span class="s2">&quot;couchdb&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Trying to connect to database...&quot;</span><span class="p">,</span>
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;blogdb&quot;</span><span class="p">]</span>
        <span class="nb">print</span> <span class="s2">&quot;succeeded.&quot;</span>
        <span class="k">break</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">parse_items</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">things</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_things</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;channel/item&quot;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># skip ones without proper URLs</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}post_date_gmt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">created</span> <span class="o">==</span> <span class="s2">&quot;0000-00-00 00:00:00&quot;</span><span class="p">:</span> <span class="n">created</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01 00:00:00&quot;</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">created</span><span class="p">,</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">created</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">post</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://purl.org/rss/1.0/modules/content/}encoded&quot;</span><span class="p">),</span>
            <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://purl.org/rss/1.0/modules/content/}encoded&quot;</span><span class="p">),</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;sil&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">created</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S +0000&quot;</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
            <span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;slug&quot;</span><span class="p">]</span>
        <span class="n">things</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment&quot;</span><span class="p">):</span>
            <span class="n">approved</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_approved&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">approved</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">c_created</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_date_gmt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c_created</span> <span class="ow">or</span> <span class="n">c_created</span> <span class="o">==</span> <span class="s2">&quot;0000-00-00 00:00:00&quot;</span><span class="p">:</span> 
                <span class="n">c_created</span> <span class="o">=</span> <span class="s2">&quot;2000-01-01 00:00:00&quot;</span>
            <span class="n">comment_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;comment</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_id&quot;</span><span class="p">),</span>
                <span class="s2">&quot;commenter&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_author&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_author_email&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_author_url&quot;</span><span class="p">),</span>
                <span class="p">},</span>
                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">c_created</span><span class="p">,</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S +0000&quot;</span><span class="p">),</span>
                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span>
                <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_content&quot;</span><span class="p">),</span>
                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;{http://wordpress.org/export/1.0/}comment_content&quot;</span><span class="p">),</span>
                <span class="s2">&quot;post_id&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;comment&quot;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Anonymous Coward&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;email&quot;</span><span class="p">]:</span>
                <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown@mailinator.com&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]:</span>
                <span class="k">del</span><span class="p">(</span><span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^https?://[^.]*..*/&quot;</span><span class="p">,</span> <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]):</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;commenter&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comment_data</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">things</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">total_things</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Saving </span><span class="si">%s</span><span class="s2"> things (so far </span><span class="si">%s</span><span class="s2"> in total)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">),</span> <span class="n">total_things</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span> 
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Couldn&#39;t update&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
                    <span class="k">raise</span>
            <span class="n">things</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">things</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Saving final </span><span class="si">%s</span><span class="s2"> things&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;Loading export file&quot;</span>
    <span class="n">wp_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">wp_file</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s2">&quot;Parsing export file&quot;</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Creating posts and comments&quot;</span>
    <span class="n">parse_items</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>This script is totally, totally hardcoded to do the things that I want
it to do, so you can't just run it, you'll need to change it. It also
doesn't recover from errors much, either. Anyway, to run the script:</p>
<div class="highlight"><pre><span></span><code><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">DELETE</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sil</span><span class="p">:</span><span class="n">couchdb</span><span class="nd">@localhost</span><span class="p">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span> <span class="c1"># delete existing DB </span>
<span class="n">couchapp</span> <span class="n">push</span> <span class="o">.</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sil</span><span class="p">:</span><span class="n">couchdb</span><span class="o">@</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span> <span class="c1"># install Sofa</span>
<span class="n">python</span> <span class="n">wordpress</span><span class="o">-</span><span class="n">import</span><span class="o">.</span><span class="n">py</span> <span class="n">wordpress</span><span class="mf">.2009</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mf">12.</span><span class="n">xml</span> <span class="c1"># import all Wordpress posts</span>
</code></pre></div>

<p>Then, of course, there's a problem. If you look at <a href="http://jchrisa.net/drl/_design/sofa/_list/index/recent-posts?descending=true&amp;limit=5">jchris's blog</a>,
the URLs are all horrible: the index page is
<code>http://jchrisa.net/drl/_design/sofa/_list/index/recent-posts?descending=true&amp;limit=5</code>,
and an individual post is
<code>http://jchrisa.net/drl/_design/sofa/_show/post/Book-progress</code>. I want
my nice Wordpress URLs - <code>/</code> for the index, <code>/2009/09/13/slug-name</code> for
a post. This is, of course, doable by putting CouchDB behind some sort
of proxy. Some people would use nginx for this; since I have Apache
running on our server anyway, I went with mod_rewrite and mod_proxy:</p>
<div class="highlight"><pre><span></span><code><span class="n">RewriteEngine</span><span class="w"> </span><span class="k">on</span>
<span class="err">#</span><span class="w"> </span><span class="n">Front</span><span class="w"> </span><span class="n">page</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="o">^</span><span class="err">$</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_list</span><span class="o">/</span><span class="k">index</span><span class="o">/</span><span class="n">recent</span><span class="o">-</span><span class="n">posts</span><span class="vm">?</span><span class="n">descending</span><span class="o">=</span><span class="k">true</span><span class="o">&amp;</span><span class="k">limit</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="n">assets</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="n">assets</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">_utils</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="n">assets</span><span class="o">/</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="n">feed</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="n">feed</span><span class="o">/</span><span class="n">atom</span><span class="w"> </span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_list</span><span class="o">/</span><span class="k">index</span><span class="o">/</span><span class="n">recent</span><span class="o">-</span><span class="n">posts</span><span class="vm">?</span><span class="n">descending</span><span class="o">=</span><span class="k">true</span><span class="o">&amp;</span><span class="k">limit</span><span class="o">=</span><span class="mi">5</span><span class="o">&amp;</span><span class="nf">format</span><span class="o">=</span><span class="n">atom</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="mi">2009</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="vm">?</span><span class="err">$</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_list</span><span class="o">/</span><span class="k">index</span><span class="o">/</span><span class="n">recent</span><span class="o">-</span><span class="n">posts</span><span class="vm">?</span><span class="n">descending</span><span class="o">=</span><span class="k">true</span><span class="o">&amp;</span><span class="k">limit</span><span class="o">=</span><span class="mi">500</span><span class="o">&amp;</span><span class="n">startkey</span><span class="o">=</span><span class="ss">&quot;$1/12/32&quot;</span><span class="o">&amp;</span><span class="n">endkey</span><span class="o">=</span><span class="ss">&quot;$1/01/00&quot;</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="mi">2009</span><span class="o">/</span><span class="mi">08</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="vm">?</span><span class="err">$</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_list</span><span class="o">/</span><span class="k">index</span><span class="o">/</span><span class="n">recent</span><span class="o">-</span><span class="n">posts</span><span class="vm">?</span><span class="n">descending</span><span class="o">=</span><span class="k">true</span><span class="o">&amp;</span><span class="k">limit</span><span class="o">=</span><span class="mi">500</span><span class="o">&amp;</span><span class="n">startkey</span><span class="o">=</span><span class="ss">&quot;$1/$2/32&quot;</span><span class="o">&amp;</span><span class="n">endkey</span><span class="o">=</span><span class="ss">&quot;$1/$2/00&quot;</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="mi">2009</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">12</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="vm">?</span><span class="err">$</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_list</span><span class="o">/</span><span class="k">index</span><span class="o">/</span><span class="n">recent</span><span class="o">-</span><span class="n">posts</span><span class="vm">?</span><span class="n">descending</span><span class="o">=</span><span class="k">true</span><span class="o">&amp;</span><span class="k">limit</span><span class="o">=</span><span class="mi">500</span><span class="o">&amp;</span><span class="n">startkey</span><span class="o">=</span><span class="ss">&quot;$1/$2/$3 24&quot;</span><span class="o">&amp;</span><span class="n">endkey</span><span class="o">=</span><span class="ss">&quot;$1/$2/$3 00&quot;</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="mi">2009</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="n">post</span><span class="p">.</span><span class="n">html</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="n">post</span><span class="p">.</span><span class="n">html</span><span class="err">$</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_show</span><span class="o">/</span><span class="n">post</span><span class="o">/</span><span class="n">post</span><span class="p">.</span><span class="n">html</span>
<span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="mi">2009</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="n">slug</span>
<span class="n">RewriteRule</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">[</span><span class="n">0-9</span><span class="o">][</span><span class="n">0-9</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="vm">?</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="err">$</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">5984</span><span class="o">/</span><span class="n">blogdb</span><span class="o">/</span><span class="n">_design</span><span class="o">/</span><span class="n">sofa</span><span class="o">/</span><span class="n">_show</span><span class="o">/</span><span class="n">post</span><span class="o">/</span><span class="err">$</span><span class="mi">1</span><span class="o">-</span><span class="err">$</span><span class="mi">2</span><span class="o">-</span><span class="err">$</span><span class="mi">3</span><span class="o">-</span><span class="err">$</span><span class="mi">4</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">]</span>
</code></pre></div>

<p>All well and good. But...then we hit the problem, and it's not a very
resolveable problem. You see, Sofa writes out HTML, and it writes out
links and so on in the nasty Sofa format. So, you can poke Sofa's JS
files to write them out differently, which I've done (edit <code>indexPath</code>,
<code>feedPath</code>, and <code>post.link</code> in <code>sofa/lists/index.js</code>), but changing
things like the URL that comments are fetched from is harder. You see,
the Couch JavaScript files assume they are running <em>on</em> Couch, and can
therefore do things like inspect the current URL to work out which
database they're in; using one of jchris's URLs, for example, you see
<code>http://jchrisa.net/drl/_design/sofa/_show/post/Book-progress</code>, with the
database name, design document name, and post ID highlighted. If you've
rewritten your URL to /2009/09/13/book-progress, that doesn't work.
Fixing this is awkward, because view URLs are calculated by
<code>jquery.couch.js</code>, which is a stock part of Couch, and so a fix would
involve forking rather a lot of Sofa. Apparently there's work going on
by the Couch team to do native URL rewrites inside Couch itself. My
migration to Sofa will likely have to wait until then, unless I write my
own CouchDB blogging engine, which is more than a weekend's job I fear.
Shame. At least now I don't have to worry about how I get CouchDB 0.10
running on ancient Debian...</p>
		</div> <!--/#entry-content-->
		<ul class="neighbours-links">
		<li><a href="https://www.kryogenix.org/days/2009/09/07/lugradio-live-2009-2/">Previous post</a></li>
		<li><a href="https://www.kryogenix.org/days/2009/09/21/zen-coding-for-gedit/">Next post</a></li>
		</ul>

		<div class="hireme">
			I'm currently available for hire, to help you plan, architect, and build new systems, and for technical writing
			and articles. You can take a look at <a href="https://kryogenix.org">some projects I've worked on</a> and
			<a href="https://kryogenix.org/books">some of my writing</a>. If you'd like to talk about your upcoming project,
			do <a href="https://kryogenix.org/contact">get in touch.</a>
		</div>
	</div> <!--/#main-->
</div>  <!--/#post-->
<div id="webmentions">
<h4>More in the discussion (powered by <a href="http://indiewebcamp.com/Webmention">webmentions</a>)</h4>
	<ul><li>(no mentions, yet.)</li></ul>
<form id="wmform" method="POST" action="https://webmention.herokuapp.com/api/webmention">
	<label>Did you link to this post? Enter your page's URL:
	<input type="url" name="source"></label>
	<input type="hidden" name="target" value="https://www.kryogenix.org/days/2009/09/13/not-moving-to-sofa-or-moving-from-the-sofa/">
	<input type="submit" value="Add link">
</form>
<script src="https://www.kryogenix.org/days/theme/live-webmentions-cors.js"></script>
</div>

<p id="oldcomments"></p>
<script>
var aurl = '2009/09/13/not-moving-to-sofa-or-moving-from-the-sofa/';
var parts = aurl.split('/');
if (parts[parts.length-1] === "") { parts = parts.slice(0, parts.length-1); }
var tooNewForOldComments = false;
if (parts[0].match(/^[0-9]+$/)) {
	var asnum = parseInt(parts[0], 10);
	if (!isNaN(asnum) && asnum > 2014) {
		tooNewForOldComments = true;
	}
}
if (!tooNewForOldComments) {
	var comurl = "/oldcomments/" + parts.join("-") + ".html";
	var x = new XMLHttpRequest();
	x.open("HEAD", comurl, true);
	x.onreadystatechange = function() {
		if (x.readyState == 4) {
			if (x.status == 200) {
				document.getElementById("oldcomments").innerHTML = '<a href="' + comurl + '">See pre-2014 comments on this post</a>';
			}
		}
	};
	x.send();
}
</script>
<script type="module">
/* jslint esversion: 11 */
try {
	const resp = await fetch("/adpb-popular.json");
	const vals = await resp.json();
	let popular = vals[location.pathname];
	if (!popular && location.pathname.endsWith("/")) {
		popular = vals[location.pathname.replace(/\/$/, "")];
	}
	if (popular && popular.recent_idx != null) {
		let a = document.createElement("a");
		let p = document.createElement("p");
		p.className = "trending";
		a.href = "/adpb-popular.html";
		a.append(`#${popular.recent_idx + 1} in Trending`);
		p.append(a);
		const ec = document.querySelector("div.entry-content");
		ec.insertBefore(p, ec.firstChild);
	}
} catch(e) {
	console.error("Failed to fetch popular list", e);
}
</script>
<script src="https://www.kryogenix.org/days/theme/unrot-redirect.js"></script>
		</div>
		
		<footer>
			<p>Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
		</footer>




<div id="loadtimer"></div>
<script>
window.onload = function(){
    setTimeout(function(){
      window.performance = window.performance || 
window.mozPerformance || window.msPerformance || 
window.webkitPerformance || {};
      var t = performance.timing || {};
      if (!t) {
        
        return;
      }
      var start = t.navigationStart,
          end = t.loadEventEnd
          loadTime = (end - start) / 1000;
      var copy = document.getElementById('loadtimer');
      copy.innerHTML += "This page loaded in " + loadTime + " seconds.";
    }, 0); 
}

</script>
</body> </html>